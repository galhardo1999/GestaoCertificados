// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id               String        @id @default(cuid())
  email            String        @unique
  nome             String?
  senha            String
  criadoEm         DateTime      @default(now())
  atualizadoEm     DateTime      @updatedAt
  certificados     Certificado[]
  clientes         Cliente[]
  templateWhatsapp String?
  urlLogo          String?
  cnpj             String?
  telefone1        String?
  telefone2        String?
  
  // Endereço
  endereco         String?
  numero           String?
  bairro           String?
  cidade           String?
  estado           String?
  cep              String?
  funcao           Funcao        @default(USUARIO)
  
  // Relação Membros da Equipe
  usuarioMestreId  String?
  usuarioMestre    Usuario?      @relation("MembrosEquipe", fields: [usuarioMestreId], references: [id])
  membrosEquipe    Usuario[]     @relation("MembrosEquipe")
  logs             LogAuditoria[]

  @@map("usuarios")
}

enum Funcao {
  USUARIO
  ADMIN
}

model Cliente {
  id              String        @id @default(cuid())
  usuarioId       String
  usuario         Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  // Dados do Cliente
  nomeEmpresa     String
  cnpj            String
  telefone        String?
  endereco        String?
  numero          String?
  bairro          String?
  cidade          String?
  estado          String?
  
  criadoEm        DateTime      @default(now())
  atualizadoEm    DateTime      @updatedAt
  
  certificados    Certificado[]

  @@index([usuarioId])
  @@map("clientes")
}

model Certificado {
  id                String            @id @default(cuid())
  usuarioId         String
  usuario           Usuario           @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  // Relação opcional com cliente
  clienteId         String?
  cliente           Cliente?          @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Armazenamento de arquivo
  chaveArquivo      String            // Chave do objeto S3
  
  // Metadados do certificado (extraídos do .pfx)
  nomeTitular       String            // Nome do titular do certificado
  dataVencimento    DateTime          // Data de vencimento
  
  // Status
  status            StatusCertificado @default(ATIVO)
  
  // Metadados opcionais (campo JSON para informações adicionais)
  metadados         Json?
  
  criadoEm          DateTime          @default(now())
  atualizadoEm      DateTime          @updatedAt
  
  logsNotificacao   LogNotificacao[]

  @@index([usuarioId])
  @@index([clienteId])
  @@index([dataVencimento])
  @@index([status])
  @@map("certificados")
}

enum StatusCertificado {
  ATIVO
  EXPIRADO
  REVOGADO
}

model LogNotificacao {
  id               String           @id @default(cuid())
  certificadoId    String
  certificado      Certificado      @relation(fields: [certificadoId], references: [id], onDelete: Cascade)
  
  tipoNotificacao  TipoNotificacao
  enviadoEm        DateTime         @default(now())
  
  @@unique([certificadoId, tipoNotificacao, enviadoEm])
  @@index([certificadoId])
  @@map("logs_notificacao")
}

enum TipoNotificacao {
  PLANEJAMENTO_45_DIAS    // 45 dias - Planejamento
  URGENCIA_15_DIAS        // 15 dias - Urgência
  CRITICO_0_DIAS          // 0 dias - Crítico
}

model Plano {
  id          String   @id @default(cuid())
  codigo      String   @unique
  nome        String
  preco       Float
  descricao   String?
  ativo       Boolean  @default(true)
  limiteUsuarios Int   @default(0)
  limiteClientes Int   @default(0)
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@map("planos")
}

model LogAuditoria {
  id          String   @id @default(cuid())
  usuarioId   String
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  acao        AcaoAuditoria
  entidade    EntidadeAuditoria
  entidadeId  String?
  detalhes    String?
  criadoEm    DateTime @default(now())

  @@index([usuarioId])
  @@index([acao])
  @@index([entidade])
  @@map("logs_auditoria")
}

enum AcaoAuditoria {
  CRIAR
  ATUALIZAR
  EXCLUIR
  LOGIN
}

enum EntidadeAuditoria {
  CLIENTE
  CERTIFICADO
  USUARIO
  PLANO
  SISTEMA
}
